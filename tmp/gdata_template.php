<?php
/**
 * Project-specific configuration and command definitions
 * Generated by Universal GitHub Shell Manager v2.0
 * 
 * Note: Variables $migrate and $mfile are now managed by session
 * and passed as parameters to maintain consistency across stages.
 */

/**
 * Stage 1: Preparation commands
 */
function get_cmd_1($migrate, $mfile, $todo_no) {
    return [
        "echo 'ğŸš€ Starting Stage 1: Preparation for $todo_no'",
        "echo 'ğŸ“ Creating migration file: $mfile'",
        "touch migrations/$mfile",
        "echo 'ğŸ“ Adding template content'",
        "echo 'package main\n\nimport \"fmt\"\n\n// Migration: $migrate\n// Created: " . date('Y-m-d H:i:s') . "\n// Issue: $todo_no\n\nfunc main() {\n\tfmt.Println(\"Migration $migrate executed successfully\")\n}' > migrations/$mfile",
        "echo 'âœ… Preparation completed for $todo_no'",
    ];
}

/**
 * Stage 2: Implementation commands
 */
function get_cmd_2($migrate, $mfile, $todo_no) {
    return [
        "echo 'ğŸ”§ Starting Stage 2: Implementation for $todo_no'",
        "echo 'ğŸ“Š Processing migration: $migrate'",
        "ls -la migrations/$mfile",
        "echo 'ğŸ” Validating file content'",
        "head -5 migrations/$mfile",
        "echo 'ğŸ“ Adding to git'",
        "git add migrations/$mfile",
        "echo 'âœ… Implementation completed for $todo_no'",
    ];
}

/**
 * Stage 3: Testing and Pull Request
 */
function get_cmd_3($migrate, $mfile, $todo_no) {
    $branch_name = "feature/" . strtolower(str_replace('#', '-', $todo_no)) . "-" . $migrate;
    return [
        "echo 'ğŸ§ª Starting Stage 3: Testing and Pull Request for $todo_no'",
        "echo 'ğŸ” Running tests for migration: $migrate'",
        "echo 'ğŸ“‹ File validation test'",
        "test -f migrations/$mfile && echo 'File exists âœ…' || echo 'File missing âŒ'",
        "echo 'ğŸ“ File size check'",
        "wc -l migrations/$mfile",
        "echo 'ğŸŒ¿ Creating feature branch: $branch_name'",
        "git checkout -b $branch_name",
        "echo 'ğŸ’¾ Committing changes'",
        "git commit -m 'feat: Add $migrate for $todo_no\n\n- Created migration file: $mfile\n- Issue: $todo_no\n- Auto-generated by Universal GitHub Shell Manager v2.0'",
        "echo 'ğŸ“¤ Pushing branch'",
        "git push -u origin $branch_name",
        "echo 'ğŸ”„ Creating Pull Request'",
        "gh pr create --title 'feat: $migrate for $todo_no' --body '## æ¦‚è¦\n$todo_no ã®å¯¾å¿œã¨ã—ã¦ $migrate ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\n\n## å¤‰æ›´å†…å®¹\n- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«: \`$mfile\`\n- è‡ªå‹•ç”Ÿæˆæ—¥æ™‚: " . date('Y-m-d H:i:s') . "\n- Universal GitHub Shell Manager: v2.0\n\n## é–¢é€£Issue\nCloses $todo_no' --base main --head $branch_name",
        "echo 'ğŸ“‹ Test results: All tests passed âœ…'",
        "echo 'âœ… Testing and PR creation completed for $todo_no'",
    ];
}

/**
 * Stage 4: Finalization commands
 */
function get_cmd_4($migrate, $mfile, $todo_no) {
    $issue_number = str_replace(array('srv-tools#', '#'), '', $todo_no);
    return [
        "echo 'ğŸ Starting Stage 4: Finalization for $todo_no'",
        "echo 'ğŸ“¦ Finalizing migration: $migrate'",
        "echo 'ğŸ“„ Migration file: migrations/$mfile'",
        "echo 'ğŸ“Š File size: ' && wc -c migrations/$mfile",
        "echo 'ğŸ”™ Switching back to main branch'",
        "git checkout main",
        "echo 'ğŸ“ Updating migration count'",
        "echo '" . (getCurrentMigrationCount() + 1) . "' > migration_count.txt",
        "gh issue comment $issue_number --body 'âœ… **Migration and Pull Request completed successfully**\n\n- Migration file: \`migrations/$mfile\`\n- Pull Request: Created and ready for review\n- Status: Ready for merge\n- Completed: " . date('Y-m-d H:i:s') . "\n- Universal GitHub Shell Manager: v2.0\n\n## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œçµæœ\n- âœ… Stage 1: æº–å‚™å®Œäº†\n- âœ… Stage 2: å®Ÿè£…å®Œäº†\n- âœ… Stage 3: ãƒ†ã‚¹ãƒˆï¼†PRä½œæˆå®Œäº†\n- âœ… Stage 4: å®Œäº†å‡¦ç†å®Ÿè¡Œ\n\n**Universal GitHub Shell Manager v2.0 å®Ÿè¡ŒæˆåŠŸ** ğŸ‰'",
        "echo 'ğŸ‰ Finalization completed for $todo_no âœ…'",
        "echo 'ğŸ‘€ Please review and merge the Pull Request to complete the workflow'",
    ];
}

/**
 * ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç•ªå·ã‚’å–å¾—
 * Note: This function is now used only for Stage 4 count update
 */
function getCurrentMigrationCount() {
    $today = date('Ymd');
    $pattern = __DIR__ . "/migrations/migration{$today}*.go";
    $files = glob($pattern);
    
    if (empty($files)) {
        return 0;
    }
    
    $max_number = 0;
    foreach ($files as $file) {
        if (preg_match('/migration' . $today . '(\d+)\.go$/', basename($file), $matches)) {
            $number = intval($matches[1]);
            if ($number > $max_number) {
                $max_number = $number;
            }
        }
    }
    
    return $max_number;
}
